<html>
    <head>
        <title>CS 416 Narrative Visualization</title>
        <style>
            body {
                font-family: Arial, Helvetica, sans-serif;
                background-color: #d9d9d9;
            }
            header {
                background-color: #d9d9d9;
                padding: 25px;
                height: 5%;
                text-align: center;
                font-size: 30px;
                color: black;
            }
            chart {
                background-color: #e9e9e9;
                width: 70%;
                height: 90%;
                display: table;
                float: left
            }
            nav {
                background-color: #d9d9d9;
                width: 30%;
                height: 10%;
                display: table;
                float: right
            }
            article {
                background-color: #d9d9d9;
                width: 28%;
                height: 65%;
                padding: 1%;
                display: table;
                text-align: left;
            }
            #nav-text {
                padding: 20px;
            }
            svg {
                width: 95%;
                height: 95%;
                display: table;
                float: left;
            }
            tooltip {
                width: 250px;
                opacity: 0;
                position: absolute;
                border-radius: 20px;
                border: 1px solid #666666;
                background-color: #dfdfdf;
                padding: 10px;
            }
            legend {
                position: absolute;
                border-radius: 20px;
                border: 1px solid #666666;
                padding: 5px;
                cursor: pointer;
                background: #dfdfdf;
            }
            legend:active {
                background: #cdcdcd;
            }
            .annotations path {
                stroke: maroon;
            }
            .subject {
                fill: crimson;
            }
            .button {
                cursor: pointer;
            }
            .button-active {
                background-color: steelblue;
            }
            .nav-bar {
                position: relative;
                top: 40%;
                left: 5%;
            }
        </style>
    </head>
    <header>The Rise of Three True Outcomes and Other Recent Trends in Major League Baseball</header>
    <script src="./d3.v7.js">
    </script>
    <script src="./d3-annotation.min.js">
    </script>
    <body onload="init(0, [`HR`], [0.5, 1.5])">
        <chart>
            <legend>
            </legend>
            <tooltip>
            </tooltip>
            <svg class="chart">
            </svg>   
        </chart>
        <nav>
            <div class="nav-bar">
                <button id="page0" class="button w3-btn w3-white w3-border button-active" onclick="loadData(0)">
                    1
                </button>
                <button id="page1" class="button w3-btn w3-white w3-border" onclick="loadData(1)">
                    2
                </button>
                <button id="page2" class="button w3-btn w3-white w3-border" onclick="loadData(2)">
                    3
                </button>
                <button id="page3" class="button w3-btn w3-white w3-border" onclick="loadData(3)">
                    4
                </button>
                <button id="page4" class="button w3-btn w3-white w3-border" onclick="loadData(4)">
                    5
                </button>
                <button class="button w3-btn w3-white w3-border" onclick="loadData(-1)">
                    Next
                </button>
            </div>
        </nav>
        <article>
        </article>
    </body>
    <script>
        const activeTimeouts = []
        var legend = true

        const svg = d3.select(`svg[class=chart]`)
        const tooltip = d3.select(`tooltip`)
        const svgDimensions = svg.node().getBoundingClientRect()

        const width = svgDimensions.width
        const height = svgDimensions.height
        const margin = 50
        const tooltipWidth = width / 45
        const tooltipText = {}
        var currentPage = 0
        const totalPages = 5

        const pageData = [{
            page: 0,
            stats: [`HR`],
            domain: [0.5, 1.5],
            articleText: `<p>Major League Baseball has a rich history that has seen many major changes in strategy. Whether these changes were due to new rules or overall growth of the talent pool, they have helped to define various eras in the league's history. This page will analyze some of the visible trends from 1980 to the current season.</p><p>Without a doubt, the most exciting play in baseball for the casual fan is the home run. The </p><p>There are a multitude of factors that affect the likelihood of a home run on any given pitch, so it would not be surprising to see variance in home run rates.</p>`
        }, {
            page: 1,
            stats: [`SO`],
            domain: [4, 8]
        }, {
            page: 2,
            stats: [`BB`],
            domain: [3, 5]
        }, {
            page: 3,
            stats: [`SB`],
            domain: [0.5, 1]
        }, {
            page: 4,
            stats: [`SH`],
            domain: [0, 0.5]
        }]

        const statColors = {
            SO: `firebrick`,
            BB: `dodgerblue`,
            HR: `yellowgreen`,
            TTO: `darkslategray`,
            R: `olivedrab`,
            SB: `darkgoldenrod`,
            SH: `blueviolet`
        }

        const statLong = {
            SO: `Strikeouts`,
            BB: `Walks`,
            HR: `Home Runs`,
            TTO: `Three True Outcomes`,
            R: `Runs`,
            SB: `Stolen Bases`,
            SH: `Sacrifice Hits`
        }

        var data = []
        const dataValues = []

        async function init(page, stats, domain) {
            data = await d3.csv(`https://dffattal.github.io/nar-viz/data/bat.csv`)

            for (var i = 44; i >= 0; i--) { //filter data from 1980-2024
                data[i][`TTO`] = (Number(data[i][`SO`]) + Number(data[i][`BB`]) + Number(data[i][`HR`])).toFixed(2)
                dataValues.push(data[i])
            }

            const axes = setAxes(domain)
            setLegendToggle(axes)
            updateLegend(stats, axes)
            drawChart(page, stats, axes)
            updateArticle()
        }

        function loadData(page) {
            if (currentPage === page) return
            else if (page === -1) {
                if (currentPage === totalPages - 1) return
                else page = currentPage + 1
            }

            d3.select(`#page${currentPage}`)
            .classed(`button-active`, false)

            d3.select(`#page${page}`)
            .classed(`button-active`, true)

            currentPage = page

            const stats = pageData[page][`stats`]
            const domain = pageData[page][`domain`]

            svg.selectAll(`circle[class=legendStat]`).remove()
            svg.selectAll(`text[class=legendLabel]`).remove()
            svg.selectAll(`#chartPath`).remove()
            svg.selectAll(`#chartData`).remove()
            svg.selectAll(`g[class=annotations]`).remove()
            svg.selectAll(`rect`).remove()
            svg.selectAll(`line`).remove()

            for (var i = 0; i < activeTimeouts.length; i++) {
                clearTimeout(activeTimeouts[i])
            }

            const axes = updateAxes(domain)
            updateLegend(stats, axes)
            drawChart(page, stats, axes)
            updateArticle()
        }

        function drawAnnotations(page, axes) {
            const xAxis = axes.xAxis
            const yAxis = axes.yAxis

            const annotationsList = [
                [{
                    note: {
                        label: `Home run rate in 1987 increased by over 16% from the previous season, breaking the 1 HR/game barrier for the first time ever. Viewers speculated that this sharp rise may have been caused by the use of a different ball that led to easier home runs.`,
                        title: `1987`,
                        bgPadding: 10
                    },
                    x: xAxis(1987),
                    y: yAxis(1.06),
                    subject: {
                        x: 'right',
                        y: 'top'
                    }
                },{
                    note: {
                        label: `The 2019 season's home run rate was a 20% increase from 2018 and more than double the rate of the 1981 season. This time, the league confirmed that the culprit was a new type of ball that had less drag. The ball would be phased out in 2022.`,
                        title: `2019`,
                        bgPadding: 10
                    },
                    x: xAxis(2019),
                    y: yAxis(1.39),
                    subject: {
                        x: 'left',
                        y: 'top'
                    }
                },{
                    note: {
                        label: `MLB officially prohibited the use of steroids in 1991, but did not begin testing players for steroids until 2003.`,
                        title: `1991`,
                        bgPadding: 10
                    },
                    x: xAxis(1991),
                    y: yAxis(0.80),
                    subject: {
                        y: 'top'
                    }
                },{
                    note: {
                        label: `In 2015, MLB introduced Statcast to all ballparks, providing advanced metrics on player movements and mechanics. This data may be heavily analyzed by coaches and players to fine-tune skills and improve performance.`,
                        title: `2015`,
                        bgPadding: 10
                    },
                    x: xAxis(2015),
                    y: yAxis(1.01),
                    subject: {
                        x: 'right',
                        y: 'bottom'
                    }
                }],
                [

                ]
            ]

            const annotations = annotationsList[page]

            const createAnnotations = d3.annotation()
            .notePadding(10)
            .type(d3.annotationBadge)
            .annotations(annotations)
            .on(`subjectover`, annotation => {
                d3.select(`tooltip`)
                .style(`opacity`, 1)
                .style(`left`, `${event.pageX + 15}px`)
                .style(`top`, `${event.pageY + 15}px`)
                .html(`${annotation.note.label}`)
            })
            .on(`subjectout`, () => {
                d3.select(`tooltip`)
                .html(``)
                .style(`opacity`, 0)
            })

            svg.append(`g`)
            .attr(`transform`, `translate(${margin},${margin})`)
            .attr(`class`, `annotations`)
            .call(createAnnotations)
        }

        function drawLineChart(statName, index, axes) {
            const xAxis = axes.xAxis
            const yAxis = axes.yAxis

            d3.selectAll(`#chartPath`)
            .remove()

            d3.selectAll(`g[class=${statName}]`)
            .remove()

            svg.append(`path`)
            .attr(`transform`, `translate(${margin},${margin})`)
            .attr(`id`, `chartPath`)
            .datum(dataValues.slice(0, index + 1))
            .attr(`fill`, `none`)
            .attr(`stroke`, statColors[statName])
            .attr(`stroke-width`, 3)
            .attr(`d`, d3.line().x(d => xAxis(d[`Year`])).y(d => yAxis(d[statName])))

            svg.append(`g`)
            .attr(`transform`, `translate(${margin},${margin})`)
            .attr(`class`, statName)
            .attr(`id`, `chartData`)
            .selectAll(`circle`)
            .data(dataValues.slice(0, index + 1))
            .enter()
            .append(`circle`)
            .style(`stroke`, `black`)
            .style(`fill`, statColors[statName])
            .attr(`r`, () => 3)
            .attr(`cx`, d => xAxis(d[`Year`]))
            .attr(`cy`, d => yAxis(d[statName]))

            if (index < 44) {
                activeTimeouts.push(setTimeout(drawLineChart, 75, statName, index + 1, axes))
            }
        }

        function drawTooltip(stats, axes) {
            const xAxis = axes.xAxis
            const yAxis = axes.yAxis

            for (var i = 0; i < 45; i++) {
                const yearData = dataValues[i]
                const year = yearData['Year']

                var htmlText = `<b>${year}</b><br>`
                for (var j = 0; j < stats.length; j++) {
                    const stat = stats[j]
                    htmlText = htmlText.concat(`<br>${statLong[stat]}: ${yearData[stat]}`)
                    tooltipText[year] = htmlText
                }

                svg.append(`rect`)
                .attr(`transform`, `translate(${margin},${margin})`)
                .attr(`class`, `tooltipHover${year}`)
                .attr(`x`, xAxis(year) - tooltipWidth / 2)
                .attr(`y`, 0)
                .attr(`width`, tooltipWidth)
                .attr(`height`, height)
                .style(`opacity`, 0)
                .attr(`z-index`, 1)
                .on(`mouseover`, event => {
                    d3.select(`line[class=tooltipLine${year}]`)
                    .style(`stroke-width`, 1)
                    d3.select(`tooltip`)
                    .style(`opacity`, 1)
                    .style(`left`, `${event.pageX + 15}px`)
                    .style(`top`, `${event.pageY + 15}px`)
                    .html(tooltipText[year])
                })
                .on(`mouseout`, () => {
                    d3.select(`line[class=tooltipLine${year}]`)
                    .style(`stroke-width`, 0)
                    d3.select(`tooltip`)
                    .html(``)
                    .style(`opacity`, 0)
                })

                svg.append(`line`)
                .attr(`transform`, `translate(${margin},${margin})`)
                .attr(`class`, `tooltipLine${year}`)
                .style(`stroke`, `black`)
                .style(`stroke-width`, 0)
                .attr(`x1`, xAxis(year))
                .attr(`x2`, xAxis(year))
                .attr(`y1`, 0)
                .attr(`y2`, height - margin * 2)
            }
        }

        function updateLegend(stats, axes) {
            const xAxis = axes.xAxis

            svg.selectAll(`circle[class=legendStat]`)
            .remove()

            svg.selectAll(`circle[class=legendStat]`)
            .data(stats)
            .enter()
            .append(`circle`)
            .attr(`class`, `legendStat`)
            .attr(`transform`, `translate(${margin},${margin})`)
            .attr(`cx`, xAxis(1981))
            .attr(`cy`, (_, i) => 10 + 20 * i)
            .attr(`r`, 5)
            .style(`fill`, stat => statColors[stat])

            svg.selectAll(`text[class=legendLabel]`)
            .remove()

            svg.selectAll(`text[class=legendLabel]`)
            .data(stats)
            .enter()
            .append(`text`)
            .attr(`class`, `legendLabel`)
            .attr(`transform`, `translate(${margin},${margin})`)
            .attr(`x`, xAxis(1981) + 20)
            .attr(`y`, (_, i) => 15 + 20 * i)
            .style(`fill`, stat => statColors[stat])
            .style(`font-weight`, `bold`)
            .text(stat => statLong[stat])
        }

        function setAxes(domain) {
            const xAxis = d3.scaleLinear()
            .domain([1980, 2024])
            .range([0, width - margin * 2])

            svg.append(`g`)
            .attr(`transform`, `translate(${margin},${height - margin})`)
            .attr(`id`, `xAxis`)
            .transition()
            .call(d3.axisBottom(xAxis).tickFormat(d3.format(`d`)))

            const yAxis = d3.scaleLinear()
            .domain(domain)
            .range([height - margin * 2, 0])

            svg.append(`g`)
            .attr(`transform`, `translate(${margin},${margin})`)
            .attr(`id`, `yAxis`)
            .transition()
            .call(d3.axisLeft(yAxis))
            
            svg.append(`text`)
            .attr(`class`, `xTitle`)
            .attr(`text-anchor`, `middle`)
            .attr(`x`, width / 2)
            .attr(`y`, height - 10)
            .text(`Season`)

            svg.append(`g`)
            .attr(`class`, `yTitleDiv`)
            .attr(`transform`, `translate(${20},${height / 2})`)
            .append(`text`)
            .attr(`class`, `yTitle`)
            .attr(`text-anchor`, `middle`)
            .attr(`transform`, `rotate(-90)`)
            .text(`Average Occurrences Per Game`)

            return {
                xAxis: xAxis,
                yAxis: yAxis
            }
        }

        function updateAxes(domain) {
            const xAxis = d3.scaleLinear()
            .domain([1980, 2024])
            .range([0, width - margin * 2])

            const yAxis = d3.scaleLinear()
            .domain(domain)
            .range([height - margin * 2, 0])

            svg.select(`#yAxis`)
            .transition()
            .duration(3000)
            .call(d3.axisLeft(yAxis))

            return {xAxis: xAxis, yAxis: yAxis}
        }

        function setLegendToggle(axes) {
            const xAxis = axes.xAxis
            const headerDimensions = d3.select(`header`).node().getBoundingClientRect()
            const legendY = headerDimensions.height + 15

            d3.select(`legend`)
            .attr(`transform`, `translate(${margin},${margin})`)
            .style(`left`, xAxis(1983))
            .style(`top`, legendY)
            .text(`Hide Legend`)
            .on(`click`, () => {
                if (legend) {
                    d3.select(`legend`)
                    .text(`Show Legend`)
                    legend = false

                    d3.selectAll(`circle[class=legendStat]`)
                    .style(`opacity`, 0)

                    d3.selectAll(`text[class=legendLabel]`)
                    .style(`opacity`, 0)
                }
                else {
                    d3.select(`legend`)
                    .text(`Hide Legend`)
                    legend = true

                    d3.selectAll(`circle[class=legendStat]`)
                    .style(`opacity`, 1)

                    d3.selectAll(`text[class=legendLabel]`)
                    .style(`opacity`, 1)
                }
            })
        }

        function drawChart(page, stats, axes) {
            const xAxis = axes.xAxis
            const yAxis = axes.yAxis
            const initialWait = 500
            const tooltipWait = 4500
            const drawAnnotationsWait = 5000

            for (var i = 0; i < stats.length; i++) {
                activeTimeouts.push(setTimeout(drawLineChart, initialWait, stats, 1, axes))
            }

            activeTimeouts.push(setTimeout(drawTooltip, tooltipWait, stats, axes))
            activeTimeouts.push(setTimeout(drawAnnotations, drawAnnotationsWait, page, axes))
        }

        function updateArticle() {
            d3.select(`article`)
            .html(pageData[currentPage][`articleText`])
        }
    </script>
</html>