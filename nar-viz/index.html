<html>
    <head>
        <title>CS 416 Narrative Visualization</title>
        <style>
            body {
                font-family: Arial, Helvetica, sans-serif
            }
            header {
                background-color: #d9d9d9;
                padding: 25px;
                text-align: center;
                font-size: 30px;
                color: black;
            }
            chart {
                background-color: #e9e9e9;
                width: 70%;
                height: 90%;
                display: table;
                float: left
            }
            nav {
                background-color: #a1a1a1;
                width: 30%;
                height: 10%;
                display: table;
                float: right
            }
            article {
                background-color: #cdcdcd;
                width: 30%;
                height: 65%;
                display: table;
                float: right;
            }
            #nav-text {
                padding: 20px;
            }
            svg {
                width: 95%;
                height: 95%;
                display: table;
                float: left;
            }
            tooltip {
                width: 250px;
                height: 100px;
                opacity: 0;
                position: absolute;
                border-radius: 20px;
                border: 1px solid #666666;
                background-color: #e9e9e9;
                padding: 10px;
            }
            .annotations path {
                stroke: maroon;
            }
            .subject {
                fill: crimson;
            }
        </style>
    </head>
    <header>The Rise of Three True Outcomes and Other Recent Trends in Major League Baseball</header>
    <script src="./d3.v7.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js">
    </script>
    <body onload="loadData()">
        <chart>
        <tooltip>
            
        </tooltip>
        <svg>

        </svg>   
        </chart>
       
        <nav>
            <p id="nav-text">
                Nav bar
            </p>
        </nav>
        <article>
            Text
        </article>
    </body>
    <script>
        // d3.select(`svg`)
        // .append(`g`)
        // .selectAll(`circle`)
        // .data([1, 4, 7, 9, 11])
        // .enter()
        // .append(`circle`)
        // .attr(`cx`, (d, i) => 100 + d)
        // .attr(`cy`, (d, i) => i * 100 + 100)
        // .attr(`r`, (d, i) => d * 4)

        // console.log([1, 4, 7, 9, 11])

        // async () => {
        //     const data = await d3.csv(`./data/bat.csv`)
        //     console.log(data)
        // }

        // d3.csv(`https://dffattal.github.io/nar-viz/data/bat.csv`)
        // .then(data => {
        //     console.log(data)
        //     for (const row in data) {
        //         console.log(data[row][`SO`])
        //     }
        // })
        // .catch(error => {
        //     console.log(error)
        // })


        async function loadData() {
            const svgDimensions = d3.select(`svg`).node().getBoundingClientRect()
            const width = svgDimensions.width
            const height = svgDimensions.height
            const margin = 50
            const tooltipWidth = width / 45

            const data = await d3.csv(`https://dffattal.github.io/nar-viz/data/bat.csv`)
            // console.log(data)
            const dataValues = []

            const tooltip = d3.select(`tooltip`)

            for (var i = 44; i >= 0; i--) { //filter data from 1980-2024
                data[i][`TTO`] = (Number(data[i][`SO`]) + Number(data[i][`BB`]) + Number(data[i][`HR`])).toFixed(2)
                dataValues.push(data[i])
            }

            const statColors = {
                SO: `firebrick`,
                BB: `dodgerblue`,
                HR: `yellowgreen`,
                TTO: `darkslategray`
            }

            function drawLineChart(statName, index) {
                d3.selectAll(`path[class=path${index - 1}]`)
                .remove()

                d3.selectAll(`g[class=${statName}]`)
                .remove()

                d3.select(`svg`)
                .append(`path`)
                .attr(`transform`, `translate(${margin},${margin})`)
                .attr(`class`, `path${index}`)
                .datum(dataValues.slice(0, index + 1))
                .attr(`fill`, `none`)
                .attr(`stroke`, statColors[statName])
                .attr(`stroke-width`, 3)
                .attr(`d`, d3.line().x(d => xAxis(d[`Year`])).y(d => statName === `TTO` ? yAxis(d[`TTO`]) : yAxis(d[statName])))

                d3.select(`svg`)
                .append(`g`)
                .attr(`transform`, `translate(${margin},${margin})`)
                .attr(`class`, statName)
                .selectAll(`circle`)
                .data(dataValues.slice(0, index + 1))
                .enter()
                .append(`circle`)
                // .on(`mouseover`, (_, d) => {
                //     tooltip.style(`opacity`, 1)
                //     .html(`Value is ${statName === `TTO` ? Number(d[`SO`]) + Number(d[`BB`]) + Number(d[`HR`]) : d[statName]}`)
                // })
                // .on(`mouseout`, (d, i) => {
                //     tooltip.style(`opacity`, 0)
                // })
                .style(`stroke`, `black`)
                .style(`fill`, statColors[statName])
                .attr(`r`, () => 3)
                .attr(`cx`, d => xAxis(d[`Year`]))
                .attr(`cy`, d => statName === `TTO` ? yAxis(d[`TTO`]) : yAxis(d[statName]))

                if (index < 44) setTimeout(drawLineChart, 75, statName, index + 1)
            }

            function drawTooltip() {
                for (var i = 0; i < 45; i++) {
                    const yearData = dataValues[i]
                    const year = yearData['Year']

                    d3.select(`svg`)
                    .append(`rect`)
                    .attr(`transform`, `translate(${margin},${margin})`)
                    .attr(`class`, `tooltipHover${year}`)
                    .attr(`x`, xAxis(year) - tooltipWidth / 2)
                    .attr(`y`, 0)
                    .attr(`width`, tooltipWidth)
                    .attr(`height`, height)
                    .style(`opacity`, 0)
                    .attr(`z-index`, 1)
                    .on(`mouseover`, event => {
                        d3.select(`line[class=tooltipLine${year}]`)
                        .style(`stroke-width`, 1)
                        d3.select(`tooltip`)
                        .style(`opacity`, 1)
                        .style(`left`, `${event.pageX + 15}px`)
                        .style(`top`, `${event.pageY + 15}px`)
                        .html(`<b>${year}</b>:<br><br>${yearData[`SO`]} strikeouts/game<br>${yearData[`BB`]} walks/game<br>${yearData[`HR`]} home runs/game<br>${yearData[`TTO`]} three true outcomes/game`)
                    })
                    .on(`mouseout`, () => {
                        d3.select(`line[class=tooltipLine${year}]`)
                        .style(`stroke-width`, 0)
                        d3.select(`tooltip`)
                        .style(`opacity`, 0)
                    })

                    d3.select(`svg`)
                    .append(`line`)
                    .attr(`transform`, `translate(${margin},${margin})`)
                    .attr(`class`, `tooltipLine${year}`)
                    .style(`stroke`, `black`)
                    .style(`stroke-width`, 0)
                    .attr(`x1`, xAxis(year))
                    .attr(`x2`, xAxis(year))
                    .attr(`y1`, 0)
                    .attr(`y2`, height - margin * 2)
                }
            }

            const xAxis = d3.scaleLinear()
            .domain([1980, 2024])
            .range([0, width - margin * 2])
            d3.select(`svg`)
            .append(`g`)
            .attr(`transform`, `translate(${margin},${height - margin})`)
            .call(d3.axisBottom(xAxis).tickFormat(d3.format(`d`)))

            const yAxis = d3.scaleLinear()
            .domain([0, 2])
            .range([height - margin * 2, 0])
            d3.select(`svg`)
            .append(`g`)
            .attr(`transform`, `translate(${margin},${margin})`)
            .call(d3.axisLeft(yAxis))
            
            d3.select(`svg`)
            .append(`text`)
            .attr(`class`, `xTitle`)
            .attr(`text-anchor`, `middle`)
            .attr(`x`, width / 2)
            .attr(`y`, height)
            .text(`Year`)

            d3.select(`svg`)
            .append(`text`)
            .attr(`class`, `yTitle`)
            .attr(`text-anchor`, `middle`)
            .attr(`x`, 500)
            .attr(`y`, 5500)
            .attr(`transform`, `rotate(-90)`)
            .text(`Test Title`)

            // setTimeout(drawLineChart, 500, `SO`, 1)
            // setTimeout(drawLineChart, 500, `BB`, 1)
            setTimeout(drawLineChart, 500, `HR`, 1)
            // setTimeout(drawLineChart, 4500, `TTO`, 1)
            setTimeout(drawTooltip, 4500)

            const annotations = [{
                note: {
                    label: `Home run rate increases by over 16%, breaking the 1 HR/game barrier for the first time.`,
                    title: `1987`,
                    bgPadding: 10
                },
                x: xAxis(1987),
                y: yAxis(1.06),
                dx: 50,
                dy: 50,
                className: `show-bg`,
                subject: {
                    x: 'right',
                    y: 'top'
                }
            }]

            const createAnnotations = d3.annotation()
            .notePadding(10)
            .type(d3.annotationBadge)
            .annotations(annotations)
            .on(`subjectover`, annotation => {
                d3.select(`tooltip`)
                .style(`opacity`, 1)
                .style(`left`, `${event.pageX + 15}px`)
                .style(`top`, `${event.pageY + 15}px`)
                .html(`${annotation.note.label}`)
            })

            d3.select(`svg`)
            .append(`g`)
            .attr(`transform`, `translate(${margin},${margin})`)
            .attr(`class`, `annotations`)
            .call(createAnnotations)

            // d3.select(`svg`)
            // .append(`path`)
            // .attr(`transform`, `translate(${margin},${margin})`)
            // .datum(dataValues)
            // .attr(`fill`, `none`)
            // .attr(`stroke`, `dodgerblue`)
            // .attr(`stroke-width`, 2)
            // .attr(`d`, d3.line().x(d => xAxis(d[`Year`])).y(d => yAxis(d[`SO`])))
        }
    </script>
</html>